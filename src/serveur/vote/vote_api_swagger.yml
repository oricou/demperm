openapi: 3.0.3
info:
  title: Vote API
  version: 1.0.0
  description: API du serveur de vote
paths:
  /api/publication:
    get:
      operationId: publication_retrieve
      description: Récupère les paramètres de publication d’un utilisateur.
      tags:
      - Preferences
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicationSetting'
          description: ''
        '403':
          description: Unauthorized
    put:
      operationId: publication_update
      description: L'utilisateur accepte ou refuse la publication automatique de son
        nombre devoix / votes et active une valeur max de voix qu'il peut recevoir
        (-1 => pas de limite).
      tags:
      - Preferences
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublicationUpdateRequest'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/PublicationUpdateRequest'
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/PublicationUpdateRequest'
        required: true
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicationSetting'
          description: ''
        '400':
          description: Requête invalide
        '403':
          description: Unauthorized
  /api/results:
    get:
      operationId: results_list
      description: 'Récupère les résultats agrégés des votes avec classement. Paramètres:
        domain, top, since (YYYY-MM-DD).'
      parameters:
      - in: query
        name: domain
        schema:
          type: string
        description: Filtrer par domaine (optionnel)
      - in: query
        name: since
        schema:
          type: string
          format: date
        description: Retourner résultats depuis cette date (YYYY-MM-DD)
      - in: query
        name: top
        schema:
          type: integer
        description: Nombre de top résultats à retourner (défaut 100)
      tags:
      - Results
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VoteResult'
          description: ''
        '400':
          description: Paramètres invalides
        '401':
          description: Unauthorized
  /api/stats/chart:
    get:
      operationId: stats_chart_list
      description: Retourne les données des scores des 10 utilisateurs avec le plus
        de voix par domaine sur les derniers jours.
      parameters:
      - in: query
        name: days
        schema:
          type: integer
          default: 30
        description: Période en jours
      - in: query
        name: domain
        schema:
          type: string
        description: Filtrer par domaine
      tags:
      - Statistics
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StatsChart'
          description: ''
        '401':
          description: Unauthorized
  /api/stats/votes/daily/{userId}:
    get:
      operationId: stats_votes_daily_retrieve
      description: Retourne les votes reçus par jour par domaine.
      parameters:
      - in: query
        name: days
        schema:
          type: integer
          default: 30
        description: Nombre de jours à retourner
      - in: query
        name: includeMonthly
        schema:
          type: boolean
          default: false
        description: Inclure aussi les données mensuelles
      - in: path
        name: userId
        schema:
          type: string
        description: Id de l'utilisateur
        required: true
      tags:
      - Statistics
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsDaily'
          description: ''
        '401':
          description: Unauthorized
  /api/stats/votes/monthly/{userId}:
    get:
      operationId: stats_votes_monthly_retrieve
      description: Retourne la série mensuelle par domaine.
      parameters:
      - in: query
        name: months
        schema:
          type: integer
          default: 12
        description: Nombre de mois à retourner
      - in: path
        name: userId
        schema:
          type: string
        description: Id de l'utilisateur
        required: true
      tags:
      - Statistics
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsMonthly'
          description: ''
        '401':
          description: Unauthorized
  /api/votes:
    post:
      operationId: votes_create
      description: Crée un vote pour un domaine donné.
      tags:
      - Votes
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoteRequest'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/VoteRequest'
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/VoteRequest'
        required: true
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '201':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vote'
          description: ''
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
  /api/votes/{domain}:
    delete:
      operationId: votes_destroy
      description: Supprime le vote de l'utilisateur authentifié pour un domaine.
      parameters:
      - in: path
        name: domain
        schema:
          type: string
        description: Domaine du vote à supprimer
        required: true
      tags:
      - Votes
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '204':
          description: Vote supprimé
        '404':
          description: Vote introuvable
        '401':
          description: Unauthorized
  /api/votes/by-voter/{voterId}:
    get:
      operationId: votes_by_voter_list
      description: Retourne la liste des votes effectués par un utilisateur donné.
      parameters:
      - in: query
        name: domain
        schema:
          type: string
        description: Filtrer par domaine
      - in: path
        name: voterId
        schema:
          type: string
        description: ID de l'utilisateur dont on veut les votes
        required: true
      tags:
      - Votes
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vote'
          description: ''
  /api/votes/by-voter/me:
    get:
      operationId: votes_by_voter_me_list
      description: Retourne la liste des votes effectués par l'utilisateur authentifié.
      parameters:
      - in: query
        name: domain
        schema:
          type: string
        description: Filtrer par domaine
      tags:
      - Votes
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vote'
          description: ''
  /api/votes/for-user/{userId}:
    get:
      operationId: votes_for_user_retrieve
      description: Retourne les votes reçus par un utilisateur.
      parameters:
      - in: query
        name: domain
        schema:
          type: string
        description: Filtrer par domaine
      - in: path
        name: userId
        schema:
          type: string
        description: Utilisateur dont on veut les votes reçus
        required: true
      tags:
      - Votes
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReceivedVotes'
          description: ''
  /api/votes/for-user/me:
    get:
      operationId: votes_for_user_me_retrieve
      description: Retourne les votes reçus par l'utilisateur authentifié.
      parameters:
      - in: query
        name: domain
        schema:
          type: string
        description: Filtrer par domaine
      tags:
      - Votes
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReceivedVotes'
          description: ''
  /api/votes/validate/force:
    get:
      operationId: votes_validate_force_retrieve
      description: Force l'exécution de la tâche quotidienne de validation des votes.
      tags:
      - Votes
      security:
      - bearerAuth: []
      - bearerAuth: []
      responses:
        '200':
          description: Validation exécutée
components:
  schemas:
    PublicationSetting:
      type: object
      description: |-
        DTO pour la réponse des endpoints de publication.
        Correspond au schéma PublicationSetting du Swagger.
      properties:
        publishVotes:
          type: boolean
        threshold:
          type: integer
          minimum: -1
      required:
      - publishVotes
      - threshold
    PublicationUpdateRequest:
      type: object
      description: |-
        DTO pour la mise à jour des préférences de publication.
        Correspond au body du PUT /publication/{userId}
      properties:
        publishVotes:
          type: boolean
        threshold:
          type: integer
          minimum: -1
      required:
      - publishVotes
      - threshold
    ReceivedVotes:
      type: object
      properties:
        userId:
          type: string
        total:
          type: integer
        byDomain:
          type: object
          additionalProperties:
            type: integer
        usersByDomain:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
      required:
      - byDomain
      - total
      - userId
      - usersByDomain
    StatsChart:
      type: object
      properties:
        domain:
          type: string
        users:
          type: array
          items:
            $ref: '#/components/schemas/StatsChartDomainField'
      required:
      - domain
      - users
    StatsChartDomainField:
      type: object
      properties:
        userId:
          type: string
        votes:
          type: array
          items:
            $ref: '#/components/schemas/StatsDailyPoint'
      required:
      - userId
      - votes
    StatsDaily:
      type: object
      properties:
        userId:
          type: string
        byDomain:
          type: array
          items:
            $ref: '#/components/schemas/StatsDailyDomain'
        monthlyByDomain:
          type: array
          items:
            $ref: '#/components/schemas/StatsMonthlyDomain'
          nullable: true
      required:
      - byDomain
      - userId
    StatsDailyDomain:
      type: object
      properties:
        domain:
          type: string
        series:
          type: array
          items:
            $ref: '#/components/schemas/StatsDailyPoint'
      required:
      - domain
      - series
    StatsDailyPoint:
      type: object
      properties:
        date:
          type: string
          format: date
        count:
          type: integer
      required:
      - count
      - date
    StatsMonthly:
      type: object
      properties:
        userId:
          type: string
        monthlyByDomain:
          type: array
          items:
            $ref: '#/components/schemas/StatsMonthlyDomain'
      required:
      - monthlyByDomain
      - userId
    StatsMonthlyDomain:
      type: object
      properties:
        domain:
          type: string
        series:
          type: array
          items:
            $ref: '#/components/schemas/StatsMonthlyPoint'
      required:
      - domain
      - series
    StatsMonthlyPoint:
      type: object
      properties:
        year:
          type: integer
        month:
          type: integer
        count:
          type: integer
      required:
      - count
      - month
      - year
    Vote:
      type: object
      properties:
        id:
          type: string
          format: uuid
        voterId:
          type: string
        targetUserId:
          type: string
        domain:
          type: string
        createdAt:
          type: string
          format: date-time
      required:
      - createdAt
      - domain
      - id
      - targetUserId
      - voterId
    VoteRequest:
      type: object
      properties:
        targetUserId:
          type: string
        domain:
          type: string
          maxLength: 100
      required:
      - domain
      - targetUserId
    VoteResult:
      type: object
      description: |-
        DTO pour la réponse de l'endpoint /results.
        Correspond au schéma VoteResult du Swagger.
      properties:
        userId:
          type: string
        domain:
          type: string
        count:
          type: integer
        elected:
          type: boolean
        electedAt:
          type: string
          format: date-time
          nullable: true
      required:
      - count
      - domain
      - elected
      - userId
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
